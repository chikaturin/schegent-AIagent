from config.llm import llm
from langchain.prompts import PromptTemplate
from langchain.chains import LLMChain
from agents.tool.interface.index import State
import json
import torch
import numpy as np
from transformers import AutoTokenizer, AutoModel
from langchain_community.vectorstores import FAISS
from langchain.embeddings.base import Embeddings
from langchain.docstore.document import Document


events = [
    {
        "DayOfWeek": "Monday",
        "title": "T·∫≠p th·ªÉ d·ª•c bu·ªïi s√°ng",
        "description": "Kh·ªüi ƒë·ªông ng√†y m·ªõi v·ªõi b√†i t·∫≠p nh·∫π nh√†ng.",
        "location": "Nh√†",
        "start_time": "2024-07-01T06:00:00",
        "end_time": "2024-07-01T06:30:00",
        "icon": "üßò‚Äç‚ôÄÔ∏è",
        "priority": "medium",
        "event_category": "habit",
    },
    {
        "DayOfWeek": "Monday",
        "title": "ƒÇn s√°ng",
        "description": "B·ªØa s√°ng chay l√†nh m·∫°nh.",
        "location": "Nh√†",
        "start_time": "2024-07-01T06:30:00",
        "end_time": "2024-07-01T07:00:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "habit",
    },
    {
        "DayOfWeek": "Monday",
        "title": "H·ªçc t·∫≠p",
        "description": "H·ªçc c√°c m√¥n quan tr·ªçng.",
        "location": "Th∆∞ vi·ªán",
        "start_time": "2024-07-01T07:00:00",
        "end_time": "2024-07-01T11:00:00",
        "icon": "üìö",
        "priority": "high",
        "event_category": "habit",
    },
    {
        "DayOfWeek": "Monday",
        "title": "Ngh·ªâ ng∆°i",
        "description": "Ngh·ªâ ng∆°i gi·ªØa bu·ªïi h·ªçc.",
        "location": "Qu√°n cafe",
        "start_time": "2024-07-01T11:00:00",
        "end_time": "2024-07-01T11:30:00",
        "icon": "‚òï",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Monday",
        "title": "ƒÇn tr∆∞a",
        "description": "B·ªØa tr∆∞a chay.",
        "location": "Nh√†",
        "start_time": "2024-07-01T11:30:00",
        "end_time": "2024-07-01T12:30:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Monday",
        "title": "L√†m vi·ªác",
        "description": "Gi·∫£i quy·∫øt c√¥ng vi·ªác.",
        "location": "VƒÉn ph√≤ng",
        "start_time": "2024-07-01T12:30:00",
        "end_time": "2024-07-01T17:00:00",
        "icon": "üíº",
        "priority": "medium",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Monday",
        "title": "Ngh·ªâ ng∆°i",
        "description": "ƒêi d·∫°o th∆∞ gi√£n.",
        "location": "C√¥ng vi√™n",
        "start_time": "2024-07-01T17:00:00",
        "end_time": "2024-07-01T17:30:00",
        "icon": "üö∂‚Äç‚ôÄÔ∏è",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Monday",
        "title": "ƒÇn t·ªëi",
        "description": "B·ªØa t·ªëi chay nh·∫π nh√†ng.",
        "location": "Nh√†",
        "start_time": "2024-07-01T18:30:00",
        "end_time": "2024-07-01T19:30:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Monday",
        "title": "ƒê·ªçc s√°ch",
        "description": "ƒê·ªçc s√°ch tr∆∞·ªõc khi ng·ªß.",
        "location": "Ph√≤ng ng·ªß",
        "start_time": "2024-07-01T21:30:00",
        "end_time": "2024-07-01T22:30:00",
        "icon": "üìñ",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Tuesday",
        "title": "Ng√†y vui ch∆°i",
        "description": "T·∫≠n h∆∞·ªüng tr·ªçn v·∫πn m·ªôt ng√†y vui v·∫ª.",
        "location": "Kh√¥ng x√°c ƒë·ªãnh",
        "start_time": "2024-07-02T06:00:00",
        "end_time": "2024-07-02T23:00:00",
        "icon": "üéâ",
        "priority": "high",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Wednesday",
        "title": "T·∫≠p th·ªÉ d·ª•c bu·ªïi s√°ng",
        "description": "Kh·ªüi ƒë·ªông ng√†y m·ªõi v·ªõi b√†i t·∫≠p nh·∫π nh√†ng.",
        "location": "Nh√†",
        "start_time": "2024-07-03T06:00:00",
        "end_time": "2024-07-03T06:30:00",
        "icon": "üßò‚Äç‚ôÄÔ∏è",
        "priority": "medium",
        "event_category": "habit",
    },
    {
        "DayOfWeek": "Wednesday",
        "title": "ƒÇn s√°ng",
        "description": "B·ªØa s√°ng chay l√†nh m·∫°nh.",
        "location": "Nh√†",
        "start_time": "2024-07-03T06:30:00",
        "end_time": "2024-07-03T07:00:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "habit",
    },
    {
        "DayOfWeek": "Wednesday",
        "title": "H·ªçc t·∫≠p",
        "description": "H·ªçc c√°c m√¥n quan tr·ªçng.",
        "location": "Th∆∞ vi·ªán",
        "start_time": "2024-07-03T07:00:00",
        "end_time": "2024-07-03T11:00:00",
        "icon": "üìö",
        "priority": "high",
        "event_category": "habit",
    },
    {
        "DayOfWeek": "Wednesday",
        "title": "Ngh·ªâ ng∆°i",
        "description": "Ngh·ªâ ng∆°i gi·ªØa bu·ªïi h·ªçc.",
        "location": "Qu√°n cafe",
        "start_time": "2024-07-03T11:00:00",
        "end_time": "2024-07-03T11:30:00",
        "icon": "‚òï",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Wednesday",
        "title": "ƒÇn tr∆∞a",
        "description": "B·ªØa tr∆∞a chay.",
        "location": "Nh√†",
        "start_time": "2024-07-03T11:30:00",
        "end_time": "2024-07-03T12:30:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Wednesday",
        "title": "L√†m vi·ªác",
        "description": "Gi·∫£i quy·∫øt c√¥ng vi·ªác.",
        "location": "VƒÉn ph√≤ng",
        "start_time": "2024-07-03T12:30:00",
        "end_time": "2024-07-03T17:00:00",
        "icon": "üíº",
        "priority": "medium",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Wednesday",
        "title": "Ngh·ªâ ng∆°i",
        "description": "ƒêi d·∫°o th∆∞ gi√£n.",
        "location": "C√¥ng vi√™n",
        "start_time": "2024-07-03T17:00:00",
        "end_time": "2024-07-03T17:30:00",
        "icon": "üö∂‚Äç‚ôÄÔ∏è",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Wednesday",
        "title": "ƒÇn t·ªëi",
        "description": "B·ªØa t·ªëi chay nh·∫π nh√†ng.",
        "location": "Nh√†",
        "start_time": "2024-07-03T18:30:00",
        "end_time": "2024-07-03T19:30:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Wednesday",
        "title": "ƒê·ªçc s√°ch",
        "description": "ƒê·ªçc s√°ch tr∆∞·ªõc khi ng·ªß.",
        "location": "Ph√≤ng ng·ªß",
        "start_time": "2024-07-03T21:30:00",
        "end_time": "2024-07-03T22:30:00",
        "icon": "üìñ",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Thursday",
        "title": "T·∫≠p th·ªÉ d·ª•c bu·ªïi s√°ng",
        "description": "Kh·ªüi ƒë·ªông ng√†y m·ªõi v·ªõi b√†i t·∫≠p nh·∫π nh√†ng.",
        "location": "Nh√†",
        "start_time": "2024-07-04T06:00:00",
        "end_time": "2024-07-04T06:30:00",
        "icon": "üßò‚Äç‚ôÄÔ∏è",
        "priority": "medium",
        "event_category": "habit",
    },
    {
        "DayOfWeek": "Thursday",
        "title": "ƒÇn s√°ng",
        "description": "B·ªØa s√°ng chay l√†nh m·∫°nh.",
        "location": "Nh√†",
        "start_time": "2024-07-04T06:30:00",
        "end_time": "2024-07-04T07:00:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "habit",
    },
    {
        "DayOfWeek": "Thursday",
        "title": "H·ªçc t·∫≠p",
        "description": "H·ªçc c√°c m√¥n quan tr·ªçng.",
        "location": "Th∆∞ vi·ªán",
        "start_time": "2024-07-04T07:00:00",
        "end_time": "2024-07-04T11:00:00",
        "icon": "üìö",
        "priority": "high",
        "event_category": "habit",
    },
    {
        "DayOfWeek": "Thursday",
        "title": "Ngh·ªâ ng∆°i",
        "description": "Ngh·ªâ ng∆°i gi·ªØa bu·ªïi h·ªçc.",
        "location": "Qu√°n cafe",
        "start_time": "2024-07-04T11:00:00",
        "end_time": "2024-07-04T11:30:00",
        "icon": "‚òï",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Thursday",
        "title": "ƒÇn tr∆∞a",
        "description": "B·ªØa tr∆∞a chay.",
        "location": "Nh√†",
        "start_time": "2024-07-04T11:30:00",
        "end_time": "2024-07-04T12:30:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Thursday",
        "title": "L√†m vi·ªác",
        "description": "Gi·∫£i quy·∫øt c√¥ng vi·ªác.",
        "location": "VƒÉn ph√≤ng",
        "start_time": "2024-07-04T12:30:00",
        "end_time": "2024-07-04T17:00:00",
        "icon": "üíº",
        "priority": "medium",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Thursday",
        "title": "Ngh·ªâ ng∆°i",
        "description": "ƒêi d·∫°o th∆∞ gi√£n.",
        "location": "C√¥ng vi√™n",
        "start_time": "2024-07-04T17:00:00",
        "end_time": "2024-07-04T17:30:00",
        "icon": "üö∂‚Äç‚ôÄÔ∏è",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Thursday",
        "title": "ƒÇn t·ªëi",
        "description": "B·ªØa t·ªëi chay nh·∫π nh√†ng.",
        "location": "Nh√†",
        "start_time": "2024-07-04T18:30:00",
        "end_time": "2024-07-04T19:30:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Thursday",
        "title": "ƒê·ªçc s√°ch",
        "description": "ƒê·ªçc s√°ch tr∆∞·ªõc khi ng·ªß.",
        "location": "Ph√≤ng ng·ªß",
        "start_time": "2024-07-04T21:30:00",
        "end_time": "2024-07-04T22:30:00",
        "icon": "üìñ",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Friday",
        "title": "T·∫≠p th·ªÉ d·ª•c bu·ªïi s√°ng",
        "description": "Kh·ªüi ƒë·ªông ng√†y m·ªõi v·ªõi b√†i t·∫≠p nh·∫π nh√†ng.",
        "location": "Nh√†",
        "start_time": "2024-07-05T06:00:00",
        "end_time": "2024-07-05T06:30:00",
        "icon": "üßò‚Äç‚ôÄÔ∏è",
        "priority": "medium",
        "event_category": "habit",
    },
    {
        "DayOfWeek": "Friday",
        "title": "ƒÇn s√°ng",
        "description": "B·ªØa s√°ng chay l√†nh m·∫°nh.",
        "location": "Nh√†",
        "start_time": "2024-07-05T06:30:00",
        "end_time": "2024-07-05T07:00:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "habit",
    },
    {
        "DayOfWeek": "Friday",
        "title": "H·ªçc t·∫≠p",
        "description": "H·ªçc c√°c m√¥n quan tr·ªçng.",
        "location": "Th∆∞ vi·ªán",
        "start_time": "2024-07-05T07:00:00",
        "end_time": "2024-07-05T11:00:00",
        "icon": "üìö",
        "priority": "high",
        "event_category": "habit",
    },
    {
        "DayOfWeek": "Friday",
        "title": "Ngh·ªâ ng∆°i",
        "description": "Ngh·ªâ ng∆°i gi·ªØa bu·ªïi h·ªçc.",
        "location": "Qu√°n cafe",
        "start_time": "2024-07-05T11:00:00",
        "end_time": "2024-07-05T11:30:00",
        "icon": "‚òï",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Friday",
        "title": "ƒÇn tr∆∞a",
        "description": "B·ªØa tr∆∞a chay.",
        "location": "Nh√†",
        "start_time": "2024-07-05T11:30:00",
        "end_time": "2024-07-05T12:30:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Friday",
        "title": "L√†m vi·ªác",
        "description": "Gi·∫£i quy·∫øt c√¥ng vi·ªác.",
        "location": "VƒÉn ph√≤ng",
        "start_time": "2024-07-05T12:30:00",
        "end_time": "2024-07-05T17:00:00",
        "icon": "üíº",
        "priority": "medium",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Friday",
        "title": "Ngh·ªâ ng∆°i",
        "description": "ƒêi d·∫°o th∆∞ gi√£n.",
        "location": "C√¥ng vi√™n",
        "start_time": "2024-07-05T17:00:00",
        "end_time": "2024-07-05T17:30:00",
        "icon": "üö∂‚Äç‚ôÄÔ∏è",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Friday",
        "title": "ƒÇn t·ªëi",
        "description": "B·ªØa t·ªëi chay nh·∫π nh√†ng.",
        "location": "Nh√†",
        "start_time": "2024-07-05T18:30:00",
        "end_time": "2024-07-05T19:30:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Friday",
        "title": "ƒê·ªçc s√°ch",
        "description": "ƒê·ªçc s√°ch tr∆∞·ªõc khi ng·ªß.",
        "location": "Ph√≤ng ng·ªß",
        "start_time": "2024-07-05T21:30:00",
        "end_time": "2024-07-05T22:30:00",
        "icon": "üìñ",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Saturday",
        "title": "T·∫≠p th·ªÉ d·ª•c nh·∫π nh√†ng",
        "description": "Yoga ho·∫∑c ƒëi b·ªô.",
        "location": "C√¥ng vi√™n",
        "start_time": "2024-07-06T07:00:00",
        "end_time": "2024-07-06T07:30:00",
        "icon": "üö∂‚Äç‚ôÄÔ∏è",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Saturday",
        "title": "ƒÇn s√°ng",
        "description": "B·ªØa s√°ng chay.",
        "location": "Nh√†",
        "start_time": "2024-07-06T07:30:00",
        "end_time": "2024-07-06T08:30:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Saturday",
        "title": "Th∆∞ gi√£n",
        "description": "Xem phim ho·∫∑c nghe nh·∫°c.",
        "location": "Nh√†",
        "start_time": "2024-07-06T08:30:00",
        "end_time": "2024-07-06T11:30:00",
        "icon": " relaxation",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Saturday",
        "title": "ƒÇn tr∆∞a",
        "description": "B·ªØa tr∆∞a chay.",
        "location": "Nh√†",
        "start_time": "2024-07-06T11:30:00",
        "end_time": "2024-07-06T12:30:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Saturday",
        "title": "ƒêi ch∆°i",
        "description": "G·∫∑p g·ª° b·∫°n b√®.",
        "location": "Qu√°n cafe",
        "start_time": "2024-07-06T14:00:00",
        "end_time": "2024-07-06T17:00:00",
        "icon": "‚òï",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Saturday",
        "title": "ƒÇn t·ªëi",
        "description": "B·ªØa t·ªëi chay.",
        "location": "Nh√†",
        "start_time": "2024-07-06T18:30:00",
        "end_time": "2024-07-06T19:30:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Saturday",
        "title": "ƒê·ªçc s√°ch",
        "description": "ƒê·ªçc s√°ch tr∆∞·ªõc khi ng·ªß.",
        "location": "Ph√≤ng ng·ªß",
        "start_time": "2024-07-06T21:30:00",
        "end_time": "2024-07-06T22:30:00",
        "icon": "üìñ",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Sunday",
        "title": "T·∫≠p th·ªÉ d·ª•c nh·∫π nh√†ng",
        "description": "Yoga ho·∫∑c ƒëi b·ªô.",
        "location": "C√¥ng vi√™n",
        "start_time": "2024-07-07T07:00:00",
        "end_time": "2024-07-07T07:30:00",
        "icon": "üö∂‚Äç‚ôÄÔ∏è",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Sunday",
        "title": "ƒÇn s√°ng",
        "description": "B·ªØa s√°ng chay.",
        "location": "Nh√†",
        "start_time": "2024-07-07T07:30:00",
        "end_time": "2024-07-07T08:30:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Sunday",
        "title": "Th∆∞ gi√£n",
        "description": "Xem phim ho·∫∑c nghe nh·∫°c.",
        "location": "Nh√†",
        "start_time": "2024-07-07T08:30:00",
        "end_time": "2024-07-07T11:30:00",
        "icon": " relaxation",
        "priority": "low",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Sunday",
        "title": "ƒÇn tr∆∞a",
        "description": "B·ªØa tr∆∞a chay.",
        "location": "Nh√†",
        "start_time": "2024-07-07T11:30:00",
        "end_time": "2024-07-07T12:30:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Sunday",
        "title": "T·ªïng k·∫øt tu·∫ßn",
        "description": "Xem l·∫°i nh·ªØng g√¨ ƒë√£ l√†m trong tu·∫ßn.",
        "location": "Nh√†",
        "start_time": "2024-07-07T14:00:00",
        "end_time": "2024-07-07T16:00:00",
        "icon": " reflection",
        "priority": "medium",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Sunday",
        "title": "ƒÇn t·ªëi",
        "description": "B·ªØa t·ªëi chay.",
        "location": "Nh√†",
        "start_time": "2024-07-07T18:30:00",
        "end_time": "2024-07-07T19:30:00",
        "icon": "üçΩÔ∏è",
        "priority": "high",
        "event_category": "general",
    },
    {
        "DayOfWeek": "Sunday",
        "title": "ƒê·ªçc s√°ch",
        "description": "ƒê·ªçc s√°ch tr∆∞·ªõc khi ng·ªß.",
        "location": "Ph√≤ng ng·ªß",
        "start_time": "2024-07-07T21:30:00",
        "end_time": "2024-07-07T22:30:00",
        "icon": "üìñ",
        "priority": "low",
        "event_category": "general",
    },
]


def genarate_habit_summarise(summarize_habits=False):
    print("Generating habit summary...")

    prompt_template = """
        B·∫°n l√† m·ªôt chuy√™n gia ph√¢n t√≠ch th√≥i quen h√†ng ng√†y c·ªßa ng∆∞·ªùi d√πng. Nhi·ªám v·ª• c·ªßa b·∫°n l√† t√≥m t·∫Øt c√°c th√≥i quen v√† s·ªü th√≠ch c·ªßa ng∆∞·ªùi d√πng d·ª±a tr√™n l·ªãch tr√¨nh ho·∫°t ƒë·ªông h√†ng tu·∫ßn.
       D·ª±a tr√™n l·ªãch tr√¨nh ho·∫°t ƒë·ªông h√†ng tu·∫ßn sau ƒë√¢y c·ªßa ng∆∞·ªùi d√πng, h√£y ph√¢n t√≠ch v√† tr√≠ch xu·∫•t c√°c nh√≥m ho·∫°t ƒë·ªông ch√≠nh m√† ng∆∞·ªùi d√πng th∆∞·ªùng th·ª±c hi·ªán, v√≠ d·ª• nh∆∞:
            ƒÇn u·ªëng

            H·ªçc t·∫≠p

            L√†m vi·ªác

            Gi·∫£i tr√≠ (bao g·ªìm ƒë·ªçc s√°ch, xem phim, ƒëi d·∫°o, ch∆°i game...)

            Ngh·ªâ ng∆°i

            G·∫∑p g·ª° b·∫°n b√® / ho·∫°t ƒë·ªông x√£ h·ªôi

            T·∫≠p th·ªÉ d·ª•c / chƒÉm s√≥c s·ª©c kh·ªèe

            V·ªõi m·ªói nh√≥m ho·∫°t ƒë·ªông, h√£y tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng JSON v·ªõi c√°c th√¥ng tin sau:

            "Nh√≥m ho·∫°t ƒë·ªông": t√™n nh√≥m

            "T·∫ßn su·∫•t": s·ªë ng√†y trong tu·∫ßn xu·∫•t hi·ªán (ho·∫∑c c√°c ng√†y c·ª• th·ªÉ)

            "Th·ªùi ƒëi·ªÉm ∆∞u ti√™n": s√°ng / chi·ªÅu / t·ªëi / linh ho·∫°t

            "M·ª©c ƒë·ªô ∆∞u ti√™n t·ªïng th·ªÉ": cao / trung b√¨nh / th·∫•p

            "S·ªü th√≠ch t·ªïng qu√°t": th√≠ch / kh√¥ng th√≠ch / b√¨nh th∆∞·ªùng

            "Ghi ch√∫ ƒë·∫∑c bi·ªát": n·∫øu c√≥ s·ª± kh√°c bi·ªát theo ng√†y (v√≠ d·ª•: th√≠ch th∆∞ gi√£n nhi·ªÅu h∆°n v√†o cu·ªëi tu·∫ßn, h·ªçc t·∫≠p nhi·ªÅu v√†o Ch·ªß nh·∫≠t...)

            Ch·ªâ tr·∫£ v·ªÅ JSON, kh√¥ng c·∫ßn gi·∫£i th√≠ch th√™m.
            M·ª•c ti√™u l√† gi√∫p h·ªá th·ªëng hi·ªÉu th√≥i quen ng∆∞·ªùi d√πng ƒë·ªÉ t·ªëi ∆∞u l·ªãch tr√¨nh sau n√†y.
        L·ªãch tr√¨nh:
        {events}
    """

    prompt = PromptTemplate(input_variables=["events"], template=prompt_template)

    summary_chain = LLMChain(llm=llm, prompt=prompt)
    print("Habit summary generated.")
    return (
        summary_chain.run(events=json.dumps(events, ensure_ascii=False))
        if summarize_habits
        else "No habit summary requested."
    )


tokenizer = AutoTokenizer.from_pretrained("sentence-transformers/LaBSE")
model = AutoModel.from_pretrained("sentence-transformers/LaBSE")


# list[np.ndarray]
# M·ªôt danh s√°ch c√°c m·∫£ng numpy, m·ªói ph·∫ßn t·ª≠ l√† 1 np.ndarray (t·ª©c m·ªôt vector embedding ·ª©ng v·ªõi t·ª´ng c√¢u)
def labse_embed(texts: list[str]) -> list[np.ndarray]:
    inputs = tokenizer(texts, return_tensors="pt", padding=True, truncation=True)
    # return_tensors="pt"
    # Y√™u c·∫ßu tokenizer tr·∫£ v·ªÅ k·∫øt qu·∫£ ·ªü d·∫°ng tensor PyTorch (pt = PyTorch).
    # padding=True
    # ƒê·∫£m b·∫£o r·∫±ng t·∫•t c·∫£ c√°c c√¢u ƒë∆∞·ª£c padding (th√™m 0) ƒë·ªÉ c√≥ c√πng ƒë·ªô d√†i ‚Äî ƒëi·ªÅu n√†y c·∫ßn thi·∫øt khi x·ª≠ l√Ω h√†ng lo·∫°t d·ªØ li·ªáu (batch).
    # truncation=True
    # N·∫øu m·ªôt c√¢u qu√° d√†i (qu√° gi·ªõi h·∫°n token c·ªßa m√¥ h√¨nh, v√≠ d·ª• 512 token), th√¨ c√¢u s·∫Ω b·ªã c·∫Øt ng·∫Øn l·∫°i.
    # ƒêi·ªÅu n√†y gi√∫p tr√°nh l·ªói khi ƒë∆∞a v√†o m√¥ h√¨nh.

    with torch.no_grad():
        outputs = model(**inputs)
        embeddings = outputs.last_hidden_state[:, 0, :]
        embeddings = torch.nn.functional.normalize(embeddings, p=2, dim=1)
    # with torch.no_grad():
    # ƒê√¢y l√† c√∫ ph√°p PyTorch ƒë·ªÉ t·∫Øt t√≠nh to√°n gradient trong ph·∫ßn n√†y.
    # Gradient ch·ªâ c·∫ßn khi b·∫°n hu·∫•n luy·ªán m√¥ h√¨nh.
    # ·ªû ƒë√¢y b·∫°n ch·ªâ l·∫•y embedding (ƒë·∫∑c tr∆∞ng) t·ª´ m√¥ h√¨nh n√™n kh√¥ng c·∫ßn gradient, l√†m v·∫≠y ti·∫øt ki·ªám b·ªô nh·ªõ v√† tƒÉng t·ªëc.
    # ----------
    # outputs = model(**inputs)
    # model l√† m√¥ h√¨nh (v√≠ d·ª• LaBSE ho·∫∑c BERT).
    # inputs l√† tensor ƒë·∫ßu v√†o (ƒë√£ ƒë∆∞·ª£c tokenizer chu·∫©n b·ªã).
    # outputs ch·ª©a k·∫øt qu·∫£ c·ªßa m√¥ h√¨nh, th√¥ng th∆∞·ªùng c√≥ nhi·ªÅu th√¥ng tin nh∆∞:
    # last_hidden_state: tensor k√≠ch th∆∞·ªõc (batch_size, seq_len, hidden_size) ‚Äî ƒë·∫°i di·ªán c√°c vector ·∫©n cho t·ª´ng token trong c√¢u.
    # C√≥ th·ªÉ c√≥ pooler_output ho·∫∑c c√°c th√†nh ph·∫ßn kh√°c t√πy m√¥ h√¨nh.
    # ----------
    # embeddings = outputs.last_hidden_state[:, 0, :]
    # outputs.last_hidden_state c√≥ shape (batch_size, seq_len, hidden_size).
    # [:, 0, :] ch·ªçn token ƒë·∫ßu ti√™n c·ªßa m·ªói c√¢u trong batch, token n√†y th∆∞·ªùng l√† token [CLS] trong BERT ‚Äî ƒë∆∞·ª£c xem l√† ƒë·∫°i di·ªán cho to√†n b·ªô c√¢u.
    # embeddings c√≥ shape (batch_size, hidden_size) ‚Äî vector embedding cho t·ª´ng c√¢u.
    # ----------
    # Chu·∫©n h√≥a embedding theo chu·∫©n L2 (chu·∫©n Euclid), nghƒ©a l√†:
    # M·ª•c ƒë√≠ch: gi√∫p embedding c√≥ ƒë·ªô d√†i b·∫±ng 1, chu·∫©n h√≥a vector ƒë·ªÉ d·ªÖ so s√°nh (v√≠ d·ª• cosine similarity).
    return embeddings.cpu().numpy()
    # embeddings hi·ªán t·∫°i ·ªü thi·∫øt b·ªã (device) GPU n·∫øu c√≥, n√™n ta chuy·ªÉn v·ªÅ CPU b·∫±ng .cpu().
    # .numpy() chuy·ªÉn tensor PyTorch th√†nh m·∫£ng NumPy, ti·ªán cho x·ª≠ l√Ω ho·∫∑c l∆∞u tr·ªØ.


def emberding_rag(state: State):
    documents = []
    response = genarate_habit_summarise(summarize_habits=True)
    cleanedResult = response.replace("```json", "").replace("```", "").strip()
    habit_summaries = json.loads(cleanedResult)

    for habit in habit_summaries:
        doc = Document(
            page_content=json.dumps(habit, ensure_ascii=False),
            metadata={"source": "habit_summaries"},
        )
        documents.append(doc)

    # T·∫°o text_embeddings ƒë√∫ng format
    texts = [doc.page_content for doc in documents]
    embeddings = labse_embed(texts)
    text_embeddings = list(zip(texts, embeddings))

    # ‚úÖ G·ªçi FAISS ƒë√∫ng c√°ch
    vectorstore = FAISS.from_embeddings(text_embeddings, documents)
    vectorstore.save_local("./faiss_index")

    state["messages"].append(
        {
            "role": "assistant",
            "content": habit_summaries,
        }
    )
    return state
